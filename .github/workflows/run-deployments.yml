name: Run deployments

on:
  deployment_status:

jobs:
  deploy-backend-to-production-environment:
    name: Deploy BE to production environment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.environment == 'fisma-benefit-app' &&
      github.event.deployment_status.state == 'success'

    steps:
      - name: Debug Event Info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Environment: ${{ github.event.deployment_status.environment }}"
          echo "State: ${{ github.event.deployment_status.state }}"

      - name: Echo Heroku automatic deployment
        run: echo "Backend is deployed automatically in Heroku"
    
  deploy-frontend-to-production-environment:
    name: Deploy FE to production environment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.environment == 'fisma-benefit-app' &&
      github.event.deployment_status.state == 'success'
    permissions:
      contents: write
      actions: read

    steps:
    - name: Debug Event Info
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Environment: ${{ github.event.deployment_status.environment }}"
        echo "State: ${{ github.event.deployment_status.state }}"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "20"

    - name: Install dependencies
      run: |
        cd frontend
        npm install

    - name: Configure Git
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Set the remote URL with authentication token
        git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

    - name: Deploy FE to GitHub Pages production environment
      env:
        VITE_SERVER_URL: ${{ secrets.HEROKU_PRODUCTION_URL }}
        VITE_BASE_PATH: /benefit-app/
      run: |
        cd frontend
        npm run deploy:production
        
    - name: Wait for GitHub Pages deployment workflow
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Function to get the latest workflow run ID for GitHub Pages build after deployment started
        get_pages_workflow_run() {
          # Use the deployment creation time as a reference
          DEPLOYMENT_CREATED_AT="${{ github.event.deployment.created_at }}"
          curl -s \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs" | \
          jq --arg created_at "$DEPLOYMENT_CREATED_AT" '
            .workflow_runs[]
            | select(.name == "pages build and deployment" and (.created_at >= $created_at))
            | .id
          ' | head -n 1
        }

        # Get the initial run ID
        echo "Waiting for GitHub Pages deployment workflow to start..."

        # Wait for a short period to allow the workflow to begin after deployment
        INITIAL_WAIT_SECONDS=20
        sleep $INITIAL_WAIT_SECONDS

        RUN_ID=$(get_pages_workflow_run)

        # Validate RUN_ID
        if [ -z "$RUN_ID" ]; then
          echo "Error: Could not find a GitHub Pages deployment workflow run. The workflow may not have started yet or the API call failed."
          exit 1
        fi

        # Wait for workflow to complete (max 5 minutes)
        TIMEOUT_SECONDS=300  # Timeout duration in seconds (5 minutes) to allow sufficient time for deployment
        
        START_TIME=$(date +%s)
        CHECK_INTERVAL_SECONDS=5

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED_TIME -gt $TIMEOUT_SECONDS ]; then
            echo "Timeout waiting for GitHub Pages deployment"
            exit 1
          fi
          
          # Get workflow status
          STATUS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID" | \
                  jq -r '.conclusion')
          
          # Check workflow status
          if [ "$STATUS" = "success" ]; then
            echo "GitHub Pages deployment completed with status ${STATUS}"
            break
          elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "cancelled" ]; then
            echo "GitHub Pages deployment failed with status ${STATUS}"
            exit 1
          fi
          
          echo "Waiting for GitHub Pages deployment workflow to complete..."
          sleep $CHECK_INTERVAL_SECONDS
        done

    # FE deployment to production resets testing environment,
    # so we deploy FE testing again after production deployment
    - name: Deploy FE to GitHub Pages testing environment
      env:
        VITE_SERVER_URL: ${{ secrets.HEROKU_TESTING_URL }}
        VITE_BASE_PATH: /benefit-app/testing/
      run: |
        echo "FE deployment to production resets testing environment, so we deploy FE testing again after production deployment"
        cd frontend
        npm run deploy:testing

  deploy-backend-to-testing-environment:
    name: Deploy BE to testing environment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.environment == 'fisma-benefit-app-testing' &&
      github.event.deployment_status.state == 'success'

    steps:
    - name: Debug Event Info
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Environment: ${{ github.event.deployment_status.environment }}"
        echo "State: ${{ github.event.deployment_status.state }}"

    - name: Echo Heroku automatic deployment
      run: echo "Backend is deployed automatically in Heroku"
  
  deploy-frontend-to-testing-environment:
    name: Deploy FE to testing environment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.environment == 'fisma-benefit-app-testing' &&
      github.event.deployment_status.state == 'success'
    permissions:
      contents: write

    steps:
    - name: Debug Event Info
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Environment: ${{ github.event.deployment_status.environment }}"
        echo "State: ${{ github.event.deployment_status.state }}"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "20"

    - name: Install dependencies
      run: |
        cd frontend
        npm install

    - name: Configure Git
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Set the remote URL with authentication token
        git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

    - name: Deploy FE to GitHub Pages testing environment
      env:
        VITE_SERVER_URL: ${{ secrets.HEROKU_TESTING_URL }}
        VITE_BASE_PATH: /benefit-app/testing/
      run: |
        cd frontend
        npm run deploy:testing